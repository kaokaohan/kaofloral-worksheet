<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥ä½œå–®ï¼ˆå”¯è®€ï¼‰</title>
  <style>
    :root{
      --bg:#f5f5f7; --card:#fff; --border:#e6e6e6;
      --text:#222; --sub:#777; --primary:#4a6fa5;
      --chip:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC","Segoe UI",sans-serif;
      color:var(--text);
    }
    .page{max-width:980px;margin:0 auto;padding:14px 12px 60px;}
    header{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    h1{font-size:1.2rem;margin:0}
    .sub{font-size:.85rem;color:var(--sub)}
    .topbar{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(to bottom, rgba(245,245,247,.98), rgba(245,245,247,.9), rgba(245,245,247,0));
      backdrop-filter: blur(6px);
      margin:0 -12px; padding:10px 12px 8px;
      border-bottom:1px solid rgba(0,0,0,0.03);
    }
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    select,input{
      padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;
      font-size:.92rem;
    }
    .list{margin-top:10px}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:14px;
      box-shadow:0 2px 8px rgba(0,0,0,.04);
      padding:12px;margin-bottom:10px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .meta{font-size:.92rem;font-weight:700}
    .chip{font-size:.78rem;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:var(--chip);color:#333}
    .content{margin-top:8px;white-space:pre-wrap;line-height:1.5}
    .note{margin-top:8px;color:#444;white-space:pre-wrap}
    .small{font-size:.84rem;color:var(--sub)}
    .flags{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .flag{font-size:.78rem;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
    .flag.ok{border-color:#2f855a;background:#e6f4ec;color:#276749;font-weight:600}
    .empty{padding:18px;text-align:center;color:var(--sub)}
    /* åœ–ç‰‡ï¼šå°ç¸®åœ– + å±•é–‹ */
    .img{margin-top:10px}
    .thumb-row{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .thumb{width:120px; height:80px;object-fit:cover;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;}
    .thumb:hover{filter:brightness(.98)}
    .img-toggle{display:inline-flex; align-items:center; gap:6px;font-size:.82rem; padding:6px 10px;border:1px solid var(--border); border-radius:999px;background:#fff; cursor:pointer;}
    .img-box{margin-top:8px;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff;}
    .img-box[hidden]{display:none;}
    .img-box img{width:100%;height:auto;display:block;max-height:520px;object-fit:contain;}
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <h1>å·¥ä½œå–®ï¼ˆå”¯è®€ï¼‰</h1>
        <div class="sub">å¤–å ´ç›´æ¥çœ‹ï¼Œä¸ç”¨ç™»å…¥</div>
      </div>
      <div class="sub">è¡Œæ”¿ç·¨è¼¯ï¼š<a href="/edit.html">edit.html</a></div>
    </header>

    <div class="topbar">
      <div class="filters">
        <input type="date" id="dateFilter" />
        <select id="groupFilter">
          <option value="all">å…¨éƒ¨åœ°å€</option>
          <option value="äºŒæ®¯çµ„">äºŒæ®¯çµ„</option>
          <option value="æ¿æ®¯çµ„">æ¿æ®¯çµ„</option>
          <option value="æ¡ƒæ®¯çµ„">æ¡ƒæ®¯çµ„</option>
          <option value="åŸºæ®¯çµ„">åŸºæ®¯çµ„</option>
          <option value="å¤–å ´çµ„">å¤–å ´çµ„</option>
        </select>
        <input type="text" id="q" placeholder="æœå°‹ï¼šåœ°é» / ä¸‹å–®äºº / å…§å®¹" />
      </div>
    </div>

    <div id="list" class="list"></div>
  </div>

<script>
  const state = { items: [] };

  function norm(s){ return String(s||"").toLowerCase().trim(); }

  function filterItems(){
    const d = document.getElementById("dateFilter").value; // YYYY-MM-DD
    const g = document.getElementById("groupFilter").value;
    const q = norm(document.getElementById("q").value);

    return state.items.filter(it=>{
      if(d && it.date !== d) return false;
      if(g !== "all" && it.group !== g) return false;
      if(q){
        const hay = norm(it.place) + " " + norm(it.buyer) + " " + norm(it.content) + " " + norm(it.note);
        if(!hay.includes(q)) return false;
      }
      return true;
    }).sort((a,b)=>{
      // date ASC then time ASC
      if(a.date !== b.date) return a.date.localeCompare(b.date);
      return (a.time||"").localeCompare(b.time||"");
    });
  }

  function render(){
    const list = document.getElementById("list");
    const items = filterItems();
    if(!items.length){
      list.innerHTML = `<div class="empty">ç›®å‰æ²’æœ‰ç¬¦åˆçš„å·¥ä½œå–®</div>`;
      return;
    }
    list.innerHTML = items.map(it=>{
      const flags = [];
      if(it.printed) flags.push(`<span class="flag ok">å·²åˆ—å°</span>`);
      else flags.push(`<span class="flag">æœªåˆ—å°</span>`);
      if(it.photoReturned) flags.push(`<span class="flag ok">å·²å›å‚³ç…§ç‰‡</span>`);
      else flags.push(`<span class="flag">æœªå›å‚³ç…§ç‰‡</span>`);

      const img = (it.image && String(it.image).trim())
        ? `
          <div class="img">
            <div class="thumb-row">
              <img class="thumb" data-act="toggle-img" loading="lazy" src="${it.image}" alt="ç¸®åœ–">
              <button class="img-toggle" data-act="toggle-img">ğŸ–¼ï¸ å±•é–‹åœ–ç‰‡</button>
            </div>
            <div class="img-box" hidden>
              <img data-act="toggle-img" loading="lazy" src="${it.image}" alt="åƒè€ƒåœ–">
            </div>
          </div>
        `
        : "";

      return `
        <div class="card">
          <div class="row">
            <div class="meta">${it.date || ""} ${it.time || ""}ï½œ${it.place || ""}</div>
            <div class="flags">
              <span class="chip">${it.group || "æœªåˆ†é¡"}</span>
              <span class="chip">ä¸‹å–®äººï¼š${it.buyer || ""}</span>
            </div>
          </div>
          <div class="content">${it.content || ""}</div>
          ${it.note ? `<div class="note"><span class="small">å‚™è¨»ï¼š</span>${it.note}</div>` : ""}
          <div class="flags" style="margin-top:10px">${flags.join("")}</div>
          ${img}
        </div>
      `;
    }).join("");
    document.querySelectorAll('[data-act="toggle-img"]').forEach(el=>{
      el.addEventListener("click", ()=>{
        // thumb æˆ– button éƒ½åœ¨ thumb-row è£¡ï¼Œimg-box åœ¨ä¸‹ä¸€å±¤
        const imgWrap = el.closest(".img");
        const box = imgWrap.querySelector(".img-box");
        const btn = imgWrap.querySelector(".img-toggle");

        const isHidden = box.hasAttribute("hidden");
        if(isHidden){
          box.removeAttribute("hidden");
          btn.textContent = "ğŸ–¼ï¸ æ”¶åˆåœ–ç‰‡";
        }else{
          box.setAttribute("hidden", "");
          btn.textContent = "ğŸ–¼ï¸ å±•é–‹åœ–ç‰‡";
        }
      });
    });
  }

  async function load(){
    const res = await fetch("/content/worksheet.json?v=" + Date.now());
    const data = await res.json();
    state.items = Array.isArray(data.items) ? data.items : [];
    render();
  }

  ["dateFilter","groupFilter","q"].forEach(id=>{
    document.getElementById(id).addEventListener("input", render);
    document.getElementById(id).addEventListener("change", render);
  });

  load();
</script>
</body>
</html>
