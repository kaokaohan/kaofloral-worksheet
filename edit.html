<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥ä½œå–®ï¼ˆç·¨è¼¯ï¼‰</title>
  <style>
    :root{--bg:#f5f5f7;--card:#fff;--border:#e6e6e6;--text:#222;--sub:#777;--primary:#4a6fa5;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC","Segoe UI",sans-serif;color:var(--text)}
    .page{max-width:1100px;margin:0 auto;padding:14px 12px 80px;}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px}
    h1{margin:0;font-size:1.2rem}
    .sub{font-size:.85rem;color:var(--sub)}
    .bar{
      position:sticky;top:0;z-index:10;margin:0 -12px;
      padding:10px 12px;background:linear-gradient(to bottom, rgba(245,245,247,.98), rgba(245,245,247,.9), rgba(245,245,247,0));
      backdrop-filter: blur(6px);
      border-bottom:1px solid rgba(0,0,0,.03);
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{
      border:1px solid var(--border);background:#fff;border-radius:10px;
      padding:8px 12px;font-size:.92rem;cursor:pointer
    }
    button.primary{border-color:var(--primary);background:var(--primary);color:#fff}
    button.danger{border-color:#c53030;background:#c53030;color:#fff}
    input,select{
      padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:.92rem;
    }
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.04);padding:12px}
    .table-wrap{overflow:auto;border-radius:12px;border:1px solid var(--border);background:#fff}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:5000px}
    th,td{border-bottom:1px solid #f0f0f0;padding:8px 10px;vertical-align:top;font-size:.9rem}
    th{position:sticky;top:0;background:#fafafa;z-index:1;text-align:left}
    tr:hover td{background:#fcfcff}
    textarea{width:100%;min-height:110px;resize:vertical;font:inherit;font-size:.9rem;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .pill{font-size:.78rem;border:1px solid var(--border);padding:4px 10px;border-radius:999px;background:#fff}
    .right{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .avatar{width:26px;height:26px;border-radius:999px;border:1px solid var(--border)}
    .hint{font-size:.82rem;color:var(--sub)}
  </style>
</head>
<body>
<div class="page">
  <header>
    <div>
      <h1>å·¥ä½œå–®ï¼ˆç·¨è¼¯ï¼‰</h1>
      <div class="sub">ç™»å…¥ GitHub å¾Œæ‰èƒ½å„²å­˜ï¼ˆæœƒ commit å› repoï¼‰</div>
    </div>
    <div class="right">
      <a class="sub" href="/index.html" target="_blank">é–‹å”¯è®€ç‰ˆ</a>
      <span id="userBox" class="pill">æœªç™»å…¥</span>
      <img id="avatar" class="avatar" style="display:none" />
    </div>
  </header>

  <div class="bar">
    <div class="row">
      <button id="btnLogin" class="primary">ç”¨ GitHub ç™»å…¥</button>
      <button id="btnLogout">ç™»å‡º</button>
      <button id="btnReload">é‡æ–°è¼‰å…¥è³‡æ–™</button>

      <span class="pill">å¿«é€Ÿæ“ä½œ</span>
      <button id="btnAdd">â• æ–°å¢ä¸€ç­†</button>
      <button id="btnClone">ğŸ“„ è¤‡è£½ä¸Šä¸€ç­†</button>
      <button id="btnDelete" class="danger">ğŸ—‘ åˆªé™¤å‹¾é¸</button>

      <span class="right">
        <span class="hint">ç¯©é¸æ—¥æœŸ</span>
        <input type="date" id="dateFilter" />
        <select id="groupFilter">
          <option value="all">å…¨éƒ¨åœ°å€</option>
          <option value="äºŒæ®¯çµ„">äºŒæ®¯çµ„</option>
          <option value="æ¿æ®¯çµ„">æ¿æ®¯çµ„</option>
          <option value="æ¡ƒæ®¯çµ„">æ¡ƒæ®¯çµ„</option>
          <option value="åŸºæ®¯çµ„">åŸºæ®¯çµ„</option>
          <option value="å¤–å ´çµ„">å¤–å ´çµ„</option>
        </select>
        <button id="btnSave" class="primary">ğŸ’¾ å„²å­˜åˆ° GitHub</button>
      </span>
    </div>
  </div>

  <div class="card" style="margin-top:10px">
    <div class="hint" id="status">ç‹€æ…‹ï¼šå°šæœªè¼‰å…¥</div>
    <div class="table-wrap" style="margin-top:10px">
      <table>
        <thead>
          <tr>
            <th style="width:60px">é¸å–</th>
            <th style="width:130px">æ—¥æœŸ</th>
            <th style="width:100px">å ´æ¬¡</th>
            <th style="width:220px">åœ°é»</th>
            <th style="width:300px">å…§å®¹</th>
            <th style="width:300px">å‚™è¨»</th>
            <th style="width:120px">ä¸‹å–®äºº</th>
            <th style="width:110px">åˆ—å°</th>
            <th style="width:120px">å›å‚³ç…§ç‰‡</th>
            <th style="width:120px">åˆ†é¡</th>
            <th style="width:220px">åœ–ç‰‡ç¶²å€</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // ======= state =======
  const state = { items: [], token: "" };

  function $(id){ return document.getElementById(id); }
  function uid(it){
    // å»ºè­°ä½ å›ºå®š idï¼šdate + time + place + buyerï¼ˆå¯è‡ªå·±æ”¹ï¼‰
    const a = (it.date||"").replaceAll("-","");
    const b = (it.time||"").replaceAll(":","");
    const c = (it.place||"").slice(0,20);
    const d = (it.buyer||"");
    return `${a}-${b}-${c}-${d}`.replace(/\s+/g,"");
  }
  function setStatus(msg){ $("status").textContent = "ç‹€æ…‹ï¼š" + msg; }

  function readTokenFromHash(){
    const h = location.hash || "";
    const m = h.match(/token=([^&]+)/);
    if(m){
      const t = decodeURIComponent(m[1]);
      localStorage.setItem("gh_token", t);
      location.hash = "";
    }
  }

  async function whoami(){
    const token = localStorage.getItem("gh_token") || "";
    state.token = token;
    if(!token){
      $("userBox").textContent = "æœªç™»å…¥";
      $("avatar").style.display = "none";
      return;
    }
    const res = await fetch("/.netlify/functions/whoami", {
      headers: { Authorization: "Bearer " + token }
    });
    if(!res.ok){
      $("userBox").textContent = "ç™»å…¥å¤±æ•ˆï¼ˆè«‹é‡æ–°ç™»å…¥ï¼‰";
      $("avatar").style.display = "none";
      return;
    }
    const me = await res.json();
    $("userBox").textContent = `å·²ç™»å…¥ï¼š${me.login}`;
    if(me.avatar_url){
      $("avatar").src = me.avatar_url;
      $("avatar").style.display = "";
    }
  }

  function filterItems(){
    const d = $("dateFilter").value;
    const g = $("groupFilter").value;
    return state.items.filter(it=>{
      if(d && it.date !== d) return false;
      if(g !== "all" && it.group !== g) return false;
      return true;
    }).sort((a,b)=>{
      if(a.date !== b.date) return a.date.localeCompare(b.date);
      return (a.time||"").localeCompare(b.time||"");
    });
  }

  function render(){
    const tbody = $("tbody");
    const items = filterItems();
    tbody.innerHTML = items.map((it, idx)=>{
      const id = it.id || uid(it);
      it.id = id;

      const checked = it._checked ? "checked" : "";
      const printed = it.printed ? "checked" : "";
      const photo = it.photoReturned ? "checked" : "";

      return `
        <tr data-id="${id}">
          <td><input type="checkbox" class="chk" ${checked}></td>
          <td><input class="cell" data-k="date" type="date" value="${it.date||""}"></td>
          <td><input class="cell" data-k="time" type="text" value="${it.time||""}" placeholder="09:00/ä¸Šåˆå ´"></td>
          <td><input class="cell" data-k="place" type="text" value="${(it.place||"").replaceAll('"','&quot;')}"></td>
          <td><textarea class="cell" data-k="content">${it.content||""}</textarea></td>
          <td><textarea class="cell" data-k="note">${it.note||""}</textarea></td>
          <td><input class="cell" data-k="buyer" type="text" value="${(it.buyer||"").replaceAll('"','&quot;')}"></td>
          <td><input class="flag" data-k="printed" type="checkbox" ${printed}></td>
          <td><input class="flag" data-k="photoReturned" type="checkbox" ${photo}></td>
          <td>
            <select class="cell" data-k="group">
              ${["äºŒæ®¯çµ„","æ¿æ®¯çµ„","æ¡ƒæ®¯çµ„","åŸºæ®¯çµ„","å¤–å ´çµ„"].map(g=>`<option value="${g}" ${it.group===g?"selected":""}>${g}</option>`).join("")}
            </select>
          </td>
          <td><input class="cell" data-k="image" type="text" value="${(it.image||"").replaceAll('"','&quot;')}" placeholder="https://..."></td>
        </tr>
      `;
    }).join("");

    // ç¶äº‹ä»¶
    tbody.querySelectorAll("tr").forEach(tr=>{
      const id = tr.dataset.id;

      tr.querySelector(".chk").addEventListener("change", (e)=>{
        const it = state.items.find(x=>x.id===id);
        it._checked = e.target.checked;
      });

      tr.querySelectorAll(".cell").forEach(el=>{
        const k = el.dataset.k;
        el.addEventListener("input", ()=>{
          const it = state.items.find(x=>x.id===id);
          it[k] = el.value;
          // id è‹¥æ˜¯ç©ºçš„ï¼Œæˆ–æ—¥æœŸ/æ™‚é–“/åœ°é»/ä¸‹å–®äººæ”¹äº†ï¼Œé‡æ–°ç”Ÿæˆ id
          if(!it.id) it.id = uid(it);
        });
      });

      tr.querySelectorAll(".flag").forEach(el=>{
        const k = el.dataset.k;
        el.addEventListener("change", ()=>{
          const it = state.items.find(x=>x.id===id);
          it[k] = el.checked;
        });
      });
    });
  }

  async function load(){
    setStatus("è¼‰å…¥ä¸­â€¦");
    const res = await fetch("/content/worksheet.json?v=" + Date.now());
    const data = await res.json();
    state.items = Array.isArray(data.items) ? data.items : [];
    setStatus(`å·²è¼‰å…¥ ${state.items.length} ç­†`);
    render();
  }

  function addNew(base){
    const it = base ? JSON.parse(JSON.stringify(base)) : {
      id: "",
      date: "",
      time: "",
      place: "",
      content: "",
      note: "",
      buyer: "",
      printed: false,
      photoReturned: false,
      group: "",
      image: ""
    };
    it.id = uid(it);
    it._checked = false;
    state.items.push(it);
    render();
    setStatus("å·²æ–°å¢ï¼ˆå°šæœªå„²å­˜ï¼‰");
  }

  function deleteChecked(){
    const before = state.items.length;
    state.items = state.items.filter(it=>!it._checked);
    const after = state.items.length;
    render();
    setStatus(`å·²åˆªé™¤ ${before-after} ç­†ï¼ˆå°šæœªå„²å­˜ï¼‰`);
  }

  async function save(){
    const token = localStorage.getItem("gh_token") || "";
    if(!token){
      alert("è«‹å…ˆç”¨ GitHub ç™»å…¥å¾Œå†å„²å­˜");
      return;
    }
    // æ¸…é™¤æš«å­˜æ¬„ä½ _checked
    const clean = state.items.map(it=>{
      const o = {...it};
      delete o._checked;
      return o;
    });
    const payload = JSON.stringify({ items: clean }, null, 2);

    setStatus("å„²å­˜ä¸­ï¼ˆcommit å› GitHubï¼‰â€¦");
    const res = await fetch("/.netlify/functions/save-worksheet", {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        Authorization:"Bearer " + token
      },
      body: JSON.stringify({
        content: payload,
        message: `Update worksheet (${new Date().toLocaleString("zh-TW")})`
      })
    });

    const out = await res.json().catch(()=>({}));
    if(!res.ok){
      console.log(out);
      alert("å„²å­˜å¤±æ•—ï¼š\n" + JSON.stringify(out, null, 2));
      setStatus("å„²å­˜å¤±æ•—ï¼ˆçœ‹ consoleï¼‰");
      return;
    }
    setStatus("âœ… å·²å„²å­˜ï¼commit: " + (out.commit || ""));
    // é‡æ–°è¼‰å…¥ç¢ºä¿ä¸€è‡´
    await load();
  }

  // ======= UI events =======
  $("btnLogin").onclick = ()=> location.href = "/.netlify/functions/auth-start";
  $("btnLogout").onclick = ()=>{
    localStorage.removeItem("gh_token");
    state.token = "";
    whoami();
    alert("å·²ç™»å‡º");
  };
  $("btnReload").onclick = load;
  $("btnAdd").onclick = ()=> addNew();
  $("btnClone").onclick = ()=>{
    const last = filterItems().slice(-1)[0];
    addNew(last || null);
  };
  $("btnDelete").onclick = deleteChecked;
  $("btnSave").onclick = save;

  $("dateFilter").addEventListener("change", render);
  $("groupFilter").addEventListener("change", render);

  // ======= init =======
  readTokenFromHash();
  whoami();
  load();
</script>
</body>
</html>
